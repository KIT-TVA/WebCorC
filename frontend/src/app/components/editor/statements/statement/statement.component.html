<p-card class="refinementBox" cdkDragBoundary="#editorContainer" #refinementBox>
  @if (!hideTargetHandle) {
    <handle type="target" position="top" />
  }
  @if (!hideSourceHandle) {
    <handle type="source" position="bottom" id="0" />
  }
  <ng-template #header>
    <p-toolbar
      #boxTitle
      style="border: none; padding-top: 0; border-radius: 1em"
    >
      <ng-template #start>
        <i [class]="icon"> </i>
      </ng-template>
      <ng-template #center>
        <p>
          {{ refinement.getTitle() }}
          <span style="color: var(--p-surface-400)">{{
            _node.statement.name
          }}</span>
        </p>
      </ng-template>
      <ng-template #end>
        <button
          pButton
          outlined
          [severity]="_node.statement.isProven ? 'success' : 'secondary'"
          [disabled]="isVerifying()"
          [style.cursor]="isVerifying() ? 'wait' : 'pointer'"
          [style.height]="'1.5rem'"
          (click)="verifyStatement()"
          size="small"
          [dt]="compactButton"
          [title]="isVerifying() ? 'Verifying...' : 'Verify this statement'"
        >
          <i
            pButtonIcon
            [class]="
              isVerifying() ? 'pi pi-spin pi-spinner' : 'pi pi-check-circle'
            "
          ></i>
          <span pButtonLabel style="font-weight: normal">
            {{ _node.statement.isProven ? "verified" : "verify" }}
          </span>
        </button>
        @if (_node.parent) {
          <p-button
            text
            icon="pi pi-trash"
            severity="danger"
            [style.cursor]="'pointer'"
            (click)="deleteRefinement()"
          >
          </p-button>
        }
      </ng-template>
    </p-toolbar>
  </ng-template>

  <div style="display: flex">
    @if (!globalSettingsService.conditionsAlwaysOpen) {
      <div appGtBorder #preconditionDiv style="width: 50px; min-height: 140px">
        <mat-drawer-container class="example-container" autosize>
          <mat-drawer #preconditionDrawer class="example-sidenav" mode="side">
            <div class="conditionParent">
              <app-condition-editor
                placeholder="Pre Condition"
                [(condition)]="_node.precondition"
                [editable]="_node.preconditionEditable()"
              ></app-condition-editor>
            </div>
          </mat-drawer>

          <mat-drawer-content class="example-sidenav-content">
            <p-button
              text
              severity="secondary"
              (click)="toggleConditionEditorView(false)"
              class="verticalButton bottomRight"
              iconPos="right"
              [icon]="
                preconditionDrawer.opened
                  ? 'pi pi-chevron-down'
                  : 'pi pi-chevron-up'
              "
              label="Precondition"
            >
            </p-button>
          </mat-drawer-content>
        </mat-drawer-container>
      </div>
    } @else {
      <div style="width: fit-content" class="conditionParent">
        <app-condition-editor
          placeholder="Pre Condition"
          [(condition)]="_node.precondition"
          [editable]="_node.preconditionEditable()"
        ></app-condition-editor>
      </div>
    }

    <div style="display: flex; align-items: center">
      <ng-content></ng-content>
    </div>
    @if (!globalSettingsService.conditionsAlwaysOpen) {
      <div appGtBorder #postconditionDiv style="width: 50px">
        <mat-drawer-container class="example-container" autosize>
          <mat-drawer
            #postconditionDrawer
            class="example-sidenav"
            mode="side"
            position="end"
          >
            <div class="conditionParent">
              <app-condition-editor
                [(condition)]="_node.postcondition"
                [editable]="_node.postconditionEditable()"
              ></app-condition-editor>
            </div>
          </mat-drawer>
          <mat-drawer-content class="example-sidenav-content">
            <p-button
              text
              severity="secondary"
              (click)="toggleConditionEditorView(true)"
              class="verticalButton bottomRight"
              [icon]="
                postconditionDrawer.opened
                  ? 'pi pi-chevron-up'
                  : 'pi pi-chevron-down'
              "
              label="Postcondition"
            >
            </p-button>
          </mat-drawer-content>
        </mat-drawer-container>
      </div>
    } @else {
      <div style="width: fit-content" class="conditionParent">
        <app-condition-editor
          placeholder="Post Condition"
          [(condition)]="_node.postcondition"
          [editable]="_node.postconditionEditable()"
        ></app-condition-editor>
      </div>
    }
  </div>
</p-card>
